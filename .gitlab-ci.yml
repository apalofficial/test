stages:
  - external-build
  - build-wait
  - test
  - qa-deploy
  - prod-deploy

external-build-job:
  tags:
    - docker
    - host_network
  secrets:
    TESTNET_CERT:
      vault: corp/build/gltest-testnet/crt@secret
      file: true
    TESTNET_KEY:
      vault: corp/build/gltest-testnet/key@secret
      file: true
  stage: external-build
  image: docker.io/alpine
  script:
    - apk add --update --no-cache dash openssl jq curl
    - dash job_scripts/queue-event.sh
  artifacts:
    paths:
      - artifacts/event_id.txt

wait-for-completion:
  tags:
    - docker
    - host_network
  stage: build-wait
  secrets:
    TESTNET_CERT:
      vault: corp/build/gltest-testnet/crt@secret
      file: true
    TESTNET_KEY:
      vault: corp/build/gltest-testnet/key@secret
      file: true
  image: docker.io/alpine
  script:
    - apk add --update --no-cache bash openssl jq curl
    - bash job_scripts/wait-for-job.sh
  artifacts:
    paths:
      - artifacts/sourcejob_id.txt
      - artifacts/job_id.txt

scan-job:
  tags:
    - docker
    - host_network
  secrets:
    TESTNET_CERT:
      vault: corp/build/gltest-testnet/crt@secret
      file: true
    TESTNET_KEY:
      vault: corp/build/gltest-testnet/key@secret
      file: true
  stage: test
  image:
    name: quay.io/skopeo/stable:latest
    entrypoint: [""]
  script:
    - bash job_scripts/upload-for-scan.sh

deploy-ci-job:
  environment:
    name: QA
    url: https://hello-ci.akamai.lol
  when: manual
  tags:
    - docker
    - host_network
    - cap_sys_admin
  secrets:
    TESTNET_CERT:
      vault: corp/build/gltest-testnet/crt@secret
      file: true
    TESTNET_KEY:
      vault: corp/build/gltest-testnet/key@secret
      file: true
    CI_DEPLOY_KEY:
      vault: corp/build/hello-ci-ed/key@secret
      file: true
    CI_DEPLOY_PUB_KEY:
      vault: corp/build/hello-ci-ed/pub@secret
      file: true
  stage: qa-deploy
  image:
    name: quay.io/podman/stable:v3.4.4
    entrypoint: [""]
  script:
    - job_scripts/deploy.sh